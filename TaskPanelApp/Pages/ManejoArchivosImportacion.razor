@page "/manejoArchivosImportacion"
@using BusinessLogic
@using Domain
@using BusinessLogic.Interfaces
@inject IEquipoLogic equipoLogic
@inject IPanelLogic panelLogic
@inject SesionLogic sesionLogic
@using Microsoft.AspNetCore.Components.Forms
@inject NavigationManager Navigation


<h3>ManejoArchivosImportacion</h3>

<div class="mb-3 d-flex align-items-center">
    <label for="equipoSelect" class="me-2">Seleccionar Equipo:</label>
    <select id="equipoSelect" class="form-control me-2" @bind="nombreEquipoSeleccionado">
        <option value="">Seleccione un equipo</option>
        @foreach (var equipo in equipos)
        {
        <option value="@equipo.Nombre">@equipo.Nombre</option>
        }
    </select>
    <button class="btn btn-primary" @onclick="CargarEquipo">Cargar Equipo</button>
</div>

@if (equipoSeleccionado != null)
{
<div class="mb-3 d-flex align-items-center">
    <label for="panelSelect" class="me-2">Seleccionar Panel:</label>
    <select id="panelSelect" class="form-control me-2" @bind="nombrePanelSeleccionado">
        <option value="">Seleccione un panel</option>
        @foreach (var panel in paneles.Where(p => p.Nombre != "Tareas Vencidas"))
        {
        <option value="@panel.Nombre">@panel.Nombre</option>
        }
    </select>
    <button class="btn btn-primary" @onclick="CargarPanel">Cargar Panel</button>
</div>
if(panelSeleccionado != null)
{
<div class="mb-3">
    <label>Nombre: </label>
    <p>@panelSeleccionado.Nombre</p>
</div>
<div class="mb-3">
    <label>Descripcion: </label>
    <p>@panelSeleccionado.Descripcion</p>
</div>
<div class="mb-3">
    <label for="fileInput" class="form-label">Importar archivo CSV:</label>
    <InputFile id="fileInput" class="form-control" OnChange="OnFileChange" />
</div>
<div class="mb-3">
    <button class="btn btn-primary" @onclick="ImportarArchivo">Importar Archivo</button>
</div>
}
}
@if (!string.IsNullOrEmpty(errorMessage))
{
<div class="alert alert-danger">
    <p>@errorMessage</p>
</div>
}
@if (!string.IsNullOrEmpty(successMessage))
{
<div class="alert alert-success">
    <p>@successMessage</p>
</div>
}

@code {
    private List<Equipo> equipos = new List<Equipo>();
    private string? nombreEquipoSeleccionado, nombrePanelSeleccionado;
    private Equipo? equipoSeleccionado;
    private List<Panel> paneles = new List<Panel>();
    private Panel panelSeleccionado;
    private string errorMessage, successMessage;
    private bool firstRender = true;


    protected override void OnInitialized()
    {
        if(sesionLogic.UsuarioLogueado != null)
        {
            equipos = equipoLogic.ListarEquipos(sesionLogic.UsuarioLogueado);
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender && sesionLogic.UsuarioLogueado == null)
        {
            if (sesionLogic.UsuarioLogueado == null)
            {
                Navigation.NavigateTo("https://localhost:7014/", true);
            }
            firstRender = false;
        }
    }
    
    private void CargarEquipo()
    {
        if (!string.IsNullOrEmpty(nombreEquipoSeleccionado))
        {
            if (!string.IsNullOrEmpty(nombreEquipoSeleccionado))
            {
                equipoSeleccionado = equipos.FirstOrDefault(e => e.Nombre == nombreEquipoSeleccionado);
                paneles = equipoSeleccionado.Paneles;
            }
        }
    }
    private void CargarPanel()
    {
        if (!string.IsNullOrEmpty(nombrePanelSeleccionado))
        {
            panelSeleccionado = paneles.FirstOrDefault(p => p.Nombre == nombrePanelSeleccionado);
        }
    }
    private IBrowserFile? archivoCsv;
    
    private void OnFileChange(InputFileChangeEventArgs e)
    {
        archivoCsv = e.File;
    }
    
    private async Task ImportarArchivo()
    {
        if (archivoCsv != null)
        {
            try
            {
                using var stream = archivoCsv.OpenReadStream();
                using var reader = new StreamReader(stream);
                var content = await reader.ReadToEndAsync();
                
                var lineas = content.Split('\n').Skip(1).ToArray();
                
                foreach (var linea in lineas)
                {
                    var datos = linea.Split(',');
                    if (datos.Length >= 3)
                    {
                        var titulo = datos[0].Trim();
                        var descripcion = datos[1].Trim();
                        if (DateTime.TryParse(datos[2].Trim(), out var fechaExpiracion))
                        {
                            
                            var tarea = new Tarea(titulo, fechaExpiracion, descripcion, 0, panelSeleccionado, panelSeleccionado);
                            
                            try
                            {
                                panelLogic.AgregarTarea(panelSeleccionado.Nombre, tarea, panelSeleccionado.EquipoAlQuePertenece);
                            }catch(Exception ex)
                            {
                                await RegistrarErrorEnLog(linea, ex.Message);
                                errorMessage = $"Error al importar el archivo: {ex.Message}";
                                return;
                            }
                            
                        }
                    }
                }
                errorMessage = null;
                successMessage = "Archivo importado con Ã©xito";
            }
            catch (Exception ex)
            {
                errorMessage = $"Error al importar el archivo: {ex.Message}";
            }
        }
        else
        {
            errorMessage = "Por favor, seleccione un archivo CSV.";
        }
    }
    private async Task RegistrarErrorEnLog(string lineaOriginal, string mensajeError)
    {
        var nombreArchivo = $"ErroresImport-{sesionLogic.UsuarioLogueado.Nombre}.txt";
        var rutaArchivo = Path.Combine(Directory.GetParent(Directory.GetCurrentDirectory()).FullName, nombreArchivo);
        var mensajeLog = $"{DateTime.UtcNow.ToString("o")}: {lineaOriginal} - {mensajeError}\n";
        File.AppendAllTextAsync(rutaArchivo, mensajeLog);
    }
}